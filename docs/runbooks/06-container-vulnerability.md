# Container Image Vulnerability (CVE)

## Trigger
- **Alert**: `github-security-alert` / `trivy-high-critical`
- **Signal**: CVE with severity HIGH/CRITICAL in CI
- **Severity**: Medium â†’ High depending on exploitability

## Immediate Response

### 1. Record Vulnerability Details
```bash
# From CI artifact
cat trivy-report.sarif | jq '.runs[].results[] | {ruleId, severity, locations}'

# From GitHub Security tab
gh api repos/:owner/:repo/dependabot/alerts
```

### 2. Freeze Deployments (if needed)
```bash
kubectl annotate deployment/userservice deploy.freeze=true
```

## Investigation Steps

1. **Identify affected images**  
   ```bash
   az acr repository show-tags --name <acr> --repository userservice
   ```
2. **Check runtime exposure**  
   ```bash
   kubectl get deploy -o jsonpath='{.items[*].spec.template.spec.containers[*].image}'
   ```
3. **Map dependency**  
   - Python package version (`pipdeptree | grep <package>`).
   - Base image (e.g., `python:3.11-slim`).

## Remediation Workflow

### 1. Patch Dependencies
```bash
pip install --upgrade <package>
pip freeze > requirements.txt
```

### 2. Rebuild and Scan
```bash
docker build -t <acr>/userservice:fix-CVE-2025-1234 ./UserService
trivy image <acr>/userservice:fix-CVE-2025-1234
```

### 3. Deploy Fixed Image
```bash
docker push <acr>/userservice:fix-CVE-2025-1234
kubectl set image deployment/userservice userservice=<acr>/userservice:fix-CVE-2025-1234
kubectl rollout status deployment/userservice
```

### 4. Remove Vulnerable Tags
```bash
az acr repository delete --name <acr> --image userservice:vulnerable-tag --yes
```

## Verification
- Trivy scan returns no HIGH/CRITICAL findings.
- GitHub/Docker Hub alerts resolved.
- smoke_test.py passes on new deployment.

## Escalation
- Vulnerability exploits remote code execution.
- No patch available and exploit in the wild.
- Regulatory disclosure required.

## Prevention
- Pin base images and dependencies in `requirements.txt`.
- Nightly Trivy scans (scheduled GitHub Action).
- Enable Dependabot alerts for Python & Docker.

## Contacts
- **DevSecOps**: devsecops@uitgo.example
- **Service Owner**: owner@uitgo.example

